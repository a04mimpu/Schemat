
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√•ntaligt Kontorsschema</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .week-separator {
            border-left: 3px solid #4f46e5;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const LockIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const UnlockIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
            </svg>
        );

        const CalendarIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const RotateIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
        );

        const DownloadIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const MonthlyScheduler = () => {
            const people = ['Gunilla', 'Minethe', 'Lennart', 'Carl'];
            const weekdays = ['M√•ndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag'];
            const locations = { H: 'Hisingen', F: 'Fr√∂lunda', HOME: 'Hemma', AWAY: 'Ledig' };

            const [schedule, setSchedule] = useState({});
            const [locked, setLocked] = useState({});
            const [stats, setStats] = useState({});
            const [startDate, setStartDate] = useState('');
            const [monthDates, setMonthDates] = useState([]);

            useEffect(() => {
                const initialStats = {};
                people.forEach(person => {
                    initialStats[person] = { H: 0, F: 0, HOME: 0 };
                });
                setStats(initialStats);
            }, []);

            useEffect(() => {
                if (startDate) {
                    calculateMonthDates(startDate);
                }
            }, [startDate]);

            const calculateMonthDates = (dateString) => {
                const start = new Date(dateString);
                const dates = [];
                let currentDate = new Date(start);
                
                for (let i = 0; i < 20; i++) {
                    // Add workdays only (skip weekends)
                    while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                setMonthDates(dates);
            };

            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}`;
            };

            const getWeekNumber = (index) => {
                return Math.floor(index / 5) + 1;
            };

            const getDayName = (index) => {
                return weekdays[index % 5];
            };

            const isFriday = (index) => {
                return index % 5 === 4; // Friday is index 4 (0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri)
            };

            const generateSchedule = () => {
                const newSchedule = {};
                const availability = {};
                
                // Check availability for all 20 days
                for (let dayIndex = 0; dayIndex < 20; dayIndex++) {
                    availability[dayIndex] = people.filter(person => {
                        const key = `${person}-${dayIndex}`;
                        return locked[key] !== 'AWAY';
                    });
                }

                const workingStats = JSON.parse(JSON.stringify(stats));

                for (let dayIndex = 0; dayIndex < 20; dayIndex++) {
                    const availablePeople = [...availability[dayIndex]];
                    const dailyAssignments = {};
                    const friday = isFriday(dayIndex);

                    // First, assign locked positions
                    people.forEach(person => {
                        const key = `${person}-${dayIndex}`;
                        if (locked[key] && locked[key] !== 'AWAY') {
                            dailyAssignments[person] = locked[key];
                            const index = availablePeople.indexOf(person);
                            if (index > -1) availablePeople.splice(index, 1);
                        }
                    });

                    // Count what's already assigned
                    const assigned = Object.values(dailyAssignments);
                    let hCount = assigned.filter(loc => loc === 'H').length;
                    let fCount = assigned.filter(loc => loc === 'F').length;
                    let homeCount = assigned.filter(loc => loc === 'HOME').length;

                    // Calculate needs based on day type
                    let needH, needF, needHome;
                    if (friday) {
                        // Friday: 0H + 2F + 2 Home
                        needH = 0;
                        needF = Math.max(0, 2 - fCount);
                        needHome = Math.max(0, 2 - homeCount);
                    } else {
                        // Mon-Thu: 1H + 2F + 1 Home
                        needH = Math.max(0, 1 - hCount);
                        needF = Math.max(0, 2 - fCount);
                        needHome = Math.max(0, 1 - homeCount);
                    }

                    const sortByNeed = (location) => {
                        return [...availablePeople].sort((a, b) => {
                            return workingStats[a][location] - workingStats[b][location];
                        });
                    };

                    // Assign Hisingen (only Mon-Thu)
                    if (needH > 0 && !friday) {
                        const candidates = sortByNeed('H');
                        for (let i = 0; i < needH && candidates.length > 0; i++) {
                            const person = candidates.shift();
                            dailyAssignments[person] = 'H';
                            workingStats[person].H++;
                            const index = availablePeople.indexOf(person);
                            if (index > -1) availablePeople.splice(index, 1);
                        }
                    }

                    // Assign Fr√∂lunda (always 2 people)
                    if (needF > 0) {
                        const candidates = sortByNeed('F');
                        for (let i = 0; i < needF && candidates.length > 0; i++) {
                            const person = candidates.shift();
                            dailyAssignments[person] = 'F';
                            workingStats[person].F++;
                            const index = availablePeople.indexOf(person);
                            if (index > -1) availablePeople.splice(index, 1);
                        }
                    }

                    // Assign Home (1 on Mon-Thu, 2 on Fri)
                    if (needHome > 0) {
                        const candidates = sortByNeed('HOME');
                        for (let i = 0; i < needHome && candidates.length > 0; i++) {
                            const person = candidates.shift();
                            dailyAssignments[person] = 'HOME';
                            workingStats[person].HOME++;
                            const index = availablePeople.indexOf(person);
                            if (index > -1) availablePeople.splice(index, 1);
                        }
                    }

                    newSchedule[dayIndex] = dailyAssignments;
                }

                setSchedule(newSchedule);
                setStats(workingStats);
            };

            const toggleLock = (person, dayIndex) => {
                const key = `${person}-${dayIndex}`;
                setLocked(prev => {
                    const newLocked = { ...prev };
                    if (newLocked[key]) {
                        delete newLocked[key];
                    } else {
                        const currentLocation = schedule[dayIndex]?.[person];
                        if (currentLocation) {
                            newLocked[key] = currentLocation;
                        }
                    }
                    return newLocked;
                });
            };

            const changeLocation = (person, dayIndex, newLocation) => {
                setSchedule(prev => {
                    const newSchedule = { ...prev };
                    if (!newSchedule[dayIndex]) {
                        newSchedule[dayIndex] = {};
                    }
                    newSchedule[dayIndex][person] = newLocation;
                    return newSchedule;
                });
            };

            const resetStats = () => {
                const resetStats = {};
                people.forEach(person => {
                    resetStats[person] = { H: 0, F: 0, HOME: 0 };
                });
                setStats(resetStats);
            };

            const getLocationColor = (location) => {
                switch(location) {
                    case 'H': return 'bg-pink-100 text-pink-800';
                    case 'F': return 'bg-green-100 text-green-800';
                    case 'HOME': return 'bg-blue-100 text-blue-800';
                    case 'AWAY': return 'bg-gray-200 text-gray-600';
                    default: return 'bg-white';
                }
            };

            const exportToExcel = () => {
                let csv = 'M√•natligt Schema\n';
                csv += 'Startdatum:,' + (startDate || 'Ej angivet') + '\n\n';
                
                // Headers
                csv += 'Person,';
                for (let i = 0; i < 20; i++) {
                    const dayName = getDayName(i);
                    const date = monthDates[i] ? formatDate(monthDates[i]) : '';
                    csv += `${dayName} ${date},`;
                }
                csv += '\n';
                
                // Data
                people.forEach(person => {
                    const row = [person];
                    for (let i = 0; i < 20; i++) {
                        const location = schedule[i]?.[person];
                        row.push(location || '');
                    }
                    csv += row.join(',') + '\n';
                });

                csv += '\nStatistik\n';
                csv += 'Person,Hisingen,Fr√∂lunda,Hemma\n';
                people.forEach(person => {
                    csv += `${person},${stats[person]?.H || 0},${stats[person]?.F || 0},${stats[person]?.HOME || 0}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `manadsschema.csv`;
                link.click();
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-[95%] mx-auto">
                        <div className="bg-white rounded-xl shadow-2xl p-8">
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-3">
                                    <CalendarIcon className="w-8 h-8 text-indigo-600" />
                                    <h1 className="text-3xl font-bold text-gray-800">M√•natligt Kontorsschema (4 veckor)</h1>
                                </div>
                                <div className="text-sm text-gray-500">
                                    <label className="block text-xs font-medium mb-1">Startdatum (m√•ndagen f√∂rsta veckan):</label>
                                    <input 
                                        type="date" 
                                        value={startDate} 
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="px-3 py-2 border rounded"
                                    />
                                </div>
                            </div>

                            <div className="flex gap-4 mb-6">
                                <button
                                    onClick={generateSchedule}
                                    className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                >
                                    <RotateIcon className="w-5 h-5" />
                                    Generera 4-veckorsschema
                                </button>
                                <button
                                    onClick={resetStats}
                                    className="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    Nollst√§ll Statistik
                                </button>
                                {Object.keys(schedule).length > 0 && (
                                    <button
                                        onClick={exportToExcel}
                                        className="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2"
                                    >
                                        <DownloadIcon className="w-5 h-5" />
                                        Exportera
                                    </button>
                                )}
                            </div>

                            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-semibold text-gray-700 mb-2">Regler:</h3>
                                <ul className="text-sm text-gray-600 space-y-1">
                                    <li>‚Ä¢ <strong>M√•ndag-Torsdag:</strong> 1 p√• Hisingen + 2 i Fr√∂lunda + 1 hemma</li>
                                    <li>‚Ä¢ <strong>Fredagar:</strong> 0 p√• Hisingen + 2 i Fr√∂lunda + 2 hemma</li>
                                    <li>‚Ä¢ Anv√§nd dropdown-menyn f√∂r att √§ndra plats manuellt</li>
                                    <li>‚Ä¢ L√•s med l√•sikonen f√∂r att beh√•lla vid n√§sta generering</li>
                                </ul>
                            </div>

                            {Object.keys(schedule).length > 0 && (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="w-full border-collapse text-sm">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="border border-gray-300 p-2 text-left font-semibold sticky left-0 bg-gray-100 z-10">Person</th>
                                                    {Array.from({ length: 20 }).map((_, dayIndex) => {
                                                        const isFirstDayOfWeek = dayIndex % 5 === 0;
                                                        return (
                                                            <th 
                                                                key={dayIndex} 
                                                                className={`border border-gray-300 p-2 text-center font-semibold ${isFirstDayOfWeek ? 'week-separator' : ''}`}
                                                            >
                                                                <div className="text-xs text-gray-500">V{getWeekNumber(dayIndex)}</div>
                                                                <div>{getDayName(dayIndex).substring(0, 3)}</div>
                                                                {monthDates[dayIndex] && (
                                                                    <div className="text-xs text-gray-600">
                                                                        {formatDate(monthDates[dayIndex])}
                                                                    </div>
                                                                )}
                                                            </th>
                                                        );
                                                    })}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {people.map(person => (
                                                    <tr key={person} className="hover:bg-gray-50">
                                                        <td className="border border-gray-300 p-2 font-medium sticky left-0 bg-white z-10">{person}</td>
                                                        {Array.from({ length: 20 }).map((_, dayIndex) => {
                                                            const location = schedule[dayIndex]?.[person];
                                                            const key = `${person}-${dayIndex}`;
                                                            const isLocked = locked[key] && locked[key] !== 'AWAY';
                                                            const isAway = locked[key] === 'AWAY';
                                                            const isFirstDayOfWeek = dayIndex % 5 === 0;
                                                            const friday = isFriday(dayIndex);
                                                            
                                                            return (
                                                                <td 
                                                                    key={dayIndex} 
                                                                    className={`border border-gray-300 p-1 ${isFirstDayOfWeek ? 'week-separator' : ''} ${friday ? 'bg-yellow-50' : ''}`}
                                                                >
                                                                    <div className="flex flex-col items-center gap-1">
                                                                        <select
                                                                            value={isAway ? 'AWAY' : (location || '')}
                                                                            onChange={(e) => {
                                                                                const value = e.target.value;
                                                                                if (value === 'AWAY') {
                                                                                    const key = `${person}-${dayIndex}`;
                                                                                    setLocked(prev => ({
                                                                                        ...prev,
                                                                                        [key]: prev[key] === 'AWAY' ? undefined : 'AWAY'
                                                                                    }));
                                                                                } else if (value === '') {
                                                                                    changeLocation(person, dayIndex, '');
                                                                                } else {
                                                                                    changeLocation(person, dayIndex, value);
                                                                                    const key = `${person}-${dayIndex}`;
                                                                                    if (locked[key] === 'AWAY') {
                                                                                        setLocked(prev => {
                                                                                            const newLocked = { ...prev };
                                                                                            delete newLocked[key];
                                                                                            return newLocked;
                                                                                        });
                                                                                    }
                                                                                }
                                                                            }}
                                                                            className={`w-full py-1 px-1 rounded text-xs font-medium text-center cursor-pointer border-0 ${
                                                                                isAway ? 'bg-gray-200 text-gray-600' : getLocationColor(location)
                                                                            }`}
                                                                        >
                                                                            <option value="">-</option>
                                                                            {!friday && <option value="H">H</option>}
                                                                            <option value="F">F</option>
                                                                            <option value="HOME">üè†</option>
                                                                            <option value="AWAY">‚úñ</option>
                                                                        </select>
                                                                        <button
                                                                            onClick={() => toggleLock(person, dayIndex)}
                                                                            className={`p-1 rounded ${
                                                                                isLocked ? 'text-yellow-600' : 'text-gray-400'
                                                                            }`}
                                                                            title={isLocked ? 'L√•st' : 'L√•s'}
                                                                        >
                                                                            {isLocked ? <LockIcon className="w-3 h-3" /> : <UnlockIcon className="w-3 h-3" />}
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            );
                                                        })}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-gray-50 p-6 rounded-lg">
                                            <h3 className="font-bold text-lg mb-4 text-gray-800">Statistik (Hela m√•naden)</h3>
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="border-b border-gray-300">
                                                        <th className="text-left py-2">Person</th>
                                                        <th className="text-center py-2">Hisingen</th>
                                                        <th className="text-center py-2">Fr√∂lunda</th>
                                                        <th className="text-center py-2">Hemma</th>
                                                        <th className="text-center py-2">Totalt kontor</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {people.map(person => (
                                                        <tr key={person} className="border-b border-gray-200">
                                                            <td className="py-2 font-medium">{person}</td>
                                                            <td className="text-center py-2">{stats[person]?.H || 0}</td>
                                                            <td className="text-center py-2">{stats[person]?.F || 0}</td>
                                                            <td className="text-center py-2">{stats[person]?.HOME || 0}</td>
                                                            <td className="text-center py-2 font-semibold">
                                                                {(stats[person]?.H || 0) + (stats[person]?.F || 0)}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="bg-gray-50 p-6 rounded-lg">
                                            <h3 className="font-bold text-lg mb-4 text-gray-800">Sammanfattning</h3>
                                            <div className="space-y-3 text-sm">
                                                <div className="flex justify-between items-center pb-2 border-b">
                                                    <span className="text-gray-600">Total arbetsplatsdagar:</span>
                                                    <span className="font-semibold">20 dagar (4 veckor)</span>
                                                </div>
                                                <div className="flex justify-between items-center pb-2 border-b">
                                                    <span className="text-gray-600">Totalt Hisingen-pass:</span>
                                                    <span className="font-semibold">16 pass (m√•n-tors)</span>
                                                </div>
                                                <div className="flex justify-between items-center pb-2 border-b">
                                                    <span className="text-gray-600">Totalt Fr√∂lunda-pass:</span>
                                                    <span className="font-semibold">40 pass (2 per dag)</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">Fredagar hemma:</span>
                                                    <span className="font-semibold">8 pass (2 per fredag)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MonthlyScheduler />, document.getElementById('root'));
    </script>
</body>
</html>
